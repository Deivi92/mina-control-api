name: CI/CD Pipeline - MinaControl Pro

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  JAVA_VERSION: '17'
  NODE_VERSION: '20'
  MAVEN_OPTS: -Xmx1024m

jobs:
  # Job para detectar cambios en backend o frontend
  detect-changes:
    name: Detectar cambios
    runs-on: ubuntu-latest
    outputs:
      backend-changed: ${{ steps.changes.outputs.backend }}
      frontend-changed: ${{ steps.changes.outputs.frontend }}
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detectar cambios en directorios
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            backend:
              - 'backend/**'
              - '.github/workflows/**'
            frontend:
              - 'frontend/**'
              - '.github/workflows/**'

  # Job para Backend (Spring Boot + Maven + Java 17)
  backend-ci:
    name: Backend - Build y Test
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend-changed == 'true'
    
    defaults:
      run:
        working-directory: ./backend
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Cache dependencias Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Validar estructura del proyecto
        run: |
          echo "ğŸ“‹ Validando estructura del proyecto backend..."
          ls -la
          if [ ! -f "pom.xml" ]; then
            echo "âŒ No se encontrÃ³ pom.xml"
            exit 1
          fi
          echo "âœ… Estructura del proyecto validada"

      - name: Compilar proyecto
        run: |
          echo "ğŸ”¨ Compilando proyecto backend..."
          mvn clean compile -B

      - name: Ejecutar tests unitarios
        run: |
          echo "ğŸ§ª Ejecutando tests unitarios..."
          mvn test -B

      - name: Ejecutar tests de integraciÃ³n
        run: |
          echo "ğŸ”§ Ejecutando tests de integraciÃ³n..."
          mvn verify -B

      - name: Generar reportes de cobertura
        run: |
          echo "ğŸ“Š Generando reportes de cobertura..."
          mvn jacoco:report -B

      - name: Verificar calidad del cÃ³digo
        run: |
          echo "ğŸ” Verificando calidad del cÃ³digo..."
          mvn checkstyle:check -B || echo "âš ï¸ Checkstyle warnings encontrados"

      - name: Empaquetar aplicaciÃ³n
        run: |
          echo "ğŸ“¦ Empaquetando aplicaciÃ³n..."
          mvn package -DskipTests -B

      - name: Subir artefactos de backend
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: backend/target/*.jar
          retention-days: 7

      - name: Subir reportes de tests
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-test-reports
          path: |
            backend/target/surefire-reports/
            backend/target/site/jacoco/
          retention-days: 7

  # Job para Frontend (React + TypeScript + Vite + Node.js)
  frontend-ci:
    name: Frontend - Build y Test
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend-changed == 'true'
    
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Validar estructura del proyecto
        run: |
          echo "ğŸ“‹ Validando estructura del proyecto frontend..."
          ls -la
          if [ ! -f "package.json" ]; then
            echo "âŒ No se encontrÃ³ package.json"
            exit 1
          fi
          echo "âœ… Estructura del proyecto validada"

      - name: Instalar dependencias
        run: |
          echo "ğŸ“¦ Instalando dependencias..."
          npm ci

      - name: Verificar compilaciÃ³n TypeScript
        run: |
          echo "ğŸ”§ Verificando compilaciÃ³n TypeScript..."
          npm run compile

      - name: Ejecutar linter (ESLint)
        run: |
          echo "ğŸ” Ejecutando linter..."
          npm run lint

      - name: Verificar formato de cÃ³digo (Prettier)
        run: |
          echo "âœ¨ Verificando formato de cÃ³digo..."
          npm run format:check

      - name: Ejecutar tests unitarios
        run: |
          echo "ğŸ§ª Ejecutando tests unitarios..."
          npm run test -- --run --coverage

      - name: Build para producciÃ³n
        run: |
          echo "ğŸ—ï¸ Generando build de producciÃ³n..."
          npm run build

      - name: Subir artefactos de frontend
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/
          retention-days: 7

      - name: Subir reportes de tests
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-test-reports
          path: |
            frontend/coverage/
          retention-days: 7

  # Job de validaciÃ³n general del monorepo
  monorepo-validation:
    name: ValidaciÃ³n del Monorepo
    runs-on: ubuntu-latest
    needs: [detect-changes]
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Validar estructura del monorepo
        run: |
          echo "ğŸ—ï¸ Validando estructura del monorepo..."
          
          # Verificar directorios principales
          if [ ! -d "backend" ] || [ ! -d "frontend" ]; then
            echo "âŒ Estructura de monorepo invÃ¡lida - faltan directorios backend o frontend"
            exit 1
          fi
          
          # Verificar archivos de configuraciÃ³n principales
          if [ ! -f "backend/pom.xml" ]; then
            echo "âŒ No se encontrÃ³ backend/pom.xml"
            exit 1
          fi
          
          if [ ! -f "frontend/package.json" ]; then
            echo "âŒ No se encontrÃ³ frontend/package.json"
            exit 1
          fi
          
          echo "âœ… Estructura del monorepo validada correctamente"

      - name: Mostrar resumen de cambios
        run: |
          echo "ğŸ“Š Resumen de cambios detectados:"
          echo "Backend cambiado: ${{ needs.detect-changes.outputs.backend-changed }}"
          echo "Frontend cambiado: ${{ needs.detect-changes.outputs.frontend-changed }}"

  # Job de resumen final
  build-summary:
    name: Resumen del Build
    runs-on: ubuntu-latest
    needs: [detect-changes, backend-ci, frontend-ci, monorepo-validation]
    if: always()
    
    steps:
      - name: Resumen de resultados
        run: |
          echo "ğŸ¯ RESUMEN DEL PIPELINE CI/CD - MinaControl Pro"
          echo "============================================="
          echo ""
          echo "ğŸ“Š Estado de los jobs:"
          echo "- DetecciÃ³n de cambios: ${{ needs.detect-changes.result }}"
          echo "- ValidaciÃ³n monorepo: ${{ needs.monorepo-validation.result }}"
          echo "- Backend CI: ${{ needs.backend-ci.result }}"
          echo "- Frontend CI: ${{ needs.frontend-ci.result }}"
          echo ""
          echo "ğŸ” Cambios detectados:"
          echo "- Backend: ${{ needs.detect-changes.outputs.backend-changed }}"
          echo "- Frontend: ${{ needs.detect-changes.outputs.frontend-changed }}"
          echo ""
          
          # Determinar estado general
          if [[ "${{ needs.backend-ci.result }}" == "failure" ]] || [[ "${{ needs.frontend-ci.result }}" == "failure" ]] || [[ "${{ needs.monorepo-validation.result }}" == "failure" ]]; then
            echo "âŒ Pipeline fallÃ³ - revisar logs de los jobs"
            exit 1
          elif [[ "${{ needs.backend-ci.result }}" == "skipped" ]] && [[ "${{ needs.frontend-ci.result }}" == "skipped" ]]; then
            echo "â­ï¸ No hay cambios que procesar"
          else
            echo "âœ… Pipeline completado exitosamente"
          fi